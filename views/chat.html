<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Knowledge-Navigator</title>
  <link rel="stylesheet" href="../styles/chatstyles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

</head>

<body class="chat-interface">
  <header class="navbar">
    <div class="logo"><img src="../styles/images/logo2.webp" alt="Documento" class="logo-image"><span
        class="Knowledge"></span></div>
    <nav>

      <a class="home-btn" href="landing.html">Home</a>
      <a class="chat-btn" href="chat.html">Chat</a>
      <a class="docs-btn" href="documents.html">Documents</a>

      <!-- Botones en tu navbar o donde quieras -->
      <a href="#" id="openLogin">Sign In</a>


      <p id="saludoUsuario" style="display:none;"></p>
      <a href="#" id="logoutBtn" style="display:none" onclick="cerrarSesion()">Logout</a>


      <a href="#" id="openRegister" class="btn-primary">Get started</a>

      <!-- Modal Login -->
      <div id="loginModal" class="modal" style="display: none;">
        <div class="modal-content">
          <span class="close" id="closeLogin">&times;</span>
          <h2>Iniciar Sesi√≥n</h2>
          <form id="loginForm">
            <input type="text" id="username" placeholder="Usuario" required><br>
            <input type="password" id="password" placeholder="Contrase√±a" required><br>
            <button type="submit">Entrar</button>
            <p id="loginError" style="color: red; display: none;">Credenciales incorrectas</p>
          </form>
        </div>
      </div>

      <!-- Modal Registro -->
      <div id="registroModal" class="modal" style="display: none;">
        <div class="modal-content">
          <span class="close" id="closeRegister">&times;</span>
          <h2>Crear Cuenta</h2>
          <form id="registroForm">
            <input type="text" id="newUsername" placeholder="Nuevo usuario" required><br>
            <input type="password" id="newPassword" placeholder="Contrase√±a" required><br>
            <button type="submit">Registrarse</button>
            <p id="registroError" style="color: red; display: none;">Nombre de usuario ya en uso</p>
          </form>
        </div>
      </div>


    </nav>
  </header>

  <div id="protectedContent" style="display: none;">
    <main class="chat-wrapper">
      <div class="chat-header">
        <div class="chat-header-title"><span class="chat-icon"><img src="../styles/images/logobot.webp" alt="Documento"
              class="bot-image"></span> Document Assistant</div>

        <label class="switch-label">
          <input type="checkbox" id="use_internet"> <span class="switch"></span>Buscar en Internet
        </label>
      </div>
      <div id="chatBox" class="chat-messages">
        <div class="message bot">
          <p>Hola! soy el asistente de documentos de tu empresa. Sube tu PDF y te ayudar√© a encontrar lo que buscas.</p>
          <span class="timestamp"></span>
        </div>
      </div>

      <div class="chat-input">
        <button class="cleanChat" onclick="clearChat()"><i class="fas fa-trash-alt"></i></button>
        <input type="text" id="question" placeholder="Ask a question about your documents..." />

        <button class="send" onclick='askBot()'>‚û§</button>
      </div>
    </main>
  </div>

  <!-- MENSAJE SOLO SI NO EST√Å LOGUEADO -->
  <div id="loginRequired" style="display: none; text-align: center; margin-top: 80px;">
    <h2 style="color: #d9534f; font-family: 'Inter', sans-serif;">
      Necesitas iniciar sesi√≥n para usar esta funci√≥n.
    </h2>
    <a href="landing.html" style="color: #007bff; text-decoration: underline;">Volver al inicio</a>
  </div>

  <script>
    async function uploadPDFs() {
      const files = document.getElementById("pdfFiles").files;
      const formData = new FormData();
      const BACKEND_URL = "http://localhost:5000"
      for (let file of files) formData.append("files", file);

      try {
        const res = await fetch("http://localhost:5000/upload", {
          method: "POST",
          body: formData
        });

        const contentType = res.headers.get("content-type");
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Error del servidor (${res.status}): ${text}`);
        }

        if (contentType && contentType.includes("application/json")) {
          const data = await res.json();
          alert(data.message);
        } else {
          const text = await res.text();
          alert("Respuesta no es JSON: " + text);
        }

      } catch (err) {
        console.error("Error al subir archivos:", err);
        alert("Error al subir archivos.");
      }
    }

    // Detectar si se pulsa Enter en el input
    document.getElementById("question").addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        event.preventDefault(); // Evita que se recargue la p√°gina (si est√° en un formulario)
        askBot(); // Llama a la funci√≥n que env√≠a el mensaje
      }
    });



    function typeResponse(text, container) {
      const messageElement = document.createElement("div");
      messageElement.className = "message bot";
      const msgContent = document.createElement("p");
      messageElement.appendChild(msgContent);
      container.appendChild(messageElement);

      let index = 0;
      const cleanText = text; // Guardar versi√≥n completa para almacenar

      function typeChar() {
        if (index < cleanText.length) {
          msgContent.textContent += cleanText.charAt(index);
          index++;
          setTimeout(typeChar, 5); // velocidad de escritura
        } else {
          // Aplicar formato markdown + saltos de l√≠nea
          msgContent.innerHTML = formatWithLineBreaks(parseMarkdownToHTML(cleanText));

          const timestamp = document.createElement("span");
          timestamp.className = "timestamp";
          timestamp.textContent = new Date().toLocaleTimeString();
          messageElement.appendChild(timestamp);

          // Guardar en historial
          saveChatHistory("Bot", cleanText, timestamp.textContent);

          container.scrollTop = container.scrollHeight;
        }
      }

      typeChar();
    }



    async function askBot() {
      const question = document.getElementById("question").value;
      const use_internet = document.getElementById("use_internet").checked;

      if (!question.trim()) return;

      appendMessage("T√∫", question);
      document.getElementById("question").value = "";

      try {
        const res = await fetch("http://localhost:5000/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, use_internet })
        });

        const data = await res.json();

        let responseText = data.answer;




        if (data.source_type) {
          responseText += `\n\n<span class="source-label">[Fuente: ${data.source_type}]</span>`;
        }
        typeResponse(responseText, chatBox);


      } catch (error) {
        console.error("Error:", error);
        appendMessage("Bot", "Ocurri√≥ un error al obtener la respuesta.");
      }
    }

    function parseMarkdownToHTML(text) {
      return text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
    }

    function formatWithLineBreaks(text) {
      return text.replace(/\n/g, "<br>");
    }

    // Funci√≥n para agregar mensajes al chatBox
    function appendMessage(sender, message) {
      const chatBox = document.getElementById("chatBox");
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message", sender === "T√∫" ? "user" : "bot");

      const msgContent = document.createElement("p");
      msgContent.textContent = message;

      if (sender === "Bot") {
        msgContent.innerHTML = formatWithLineBreaks(parseMarkdownToHTML(message));  
      } else {
        msgContent.textContent = message;
      }

      const timestamp = document.createElement("span");
      timestamp.classList.add("timestamp");
      timestamp.textContent = new Date().toLocaleTimeString();

      msgDiv.appendChild(msgContent);
      msgDiv.appendChild(timestamp);
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;

      // Guardar en localStorage
      saveChatHistory(sender, message, timestamp.textContent);
    }

    function saveChatHistory(sender, message, timestamp) {
      const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      history.push({ sender, message, timestamp });
      localStorage.setItem("chatHistory", JSON.stringify(history));
    }

    function loadChatHistory() {
      const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";  // Limpiar antes

      if (history.length === 0) {
        const documentosSubidos = localStorage.getItem("documentosSubidos") === "true";
        const mensaje = documentosSubidos
          ? "¬°Estoy listo para ayudarte con los documentos que subiste!"
          : "Hola! Sube tu PDF y te ayudar√© a encontrar lo que buscas.";
        appendMessage("Bot", mensaje);
      } else {
        for (let msg of history) {
          const msgDiv = document.createElement("div");
          msgDiv.classList.add("message", msg.sender === "T√∫" ? "user" : "bot");


          const msgContent = document.createElement("p");
          if (msg.sender === "Bot") {
            msgContent.innerHTML = formatWithLineBreaks(parseMarkdownToHTML(msg.message));
          } else {
            msgContent.textContent = msg.message;
          }


          const timestamp = document.createElement("span");
          timestamp.classList.add("timestamp");
          timestamp.textContent = msg.timestamp;

          msgDiv.appendChild(msgContent);
          msgDiv.appendChild(timestamp);
          chatBox.appendChild(msgDiv);
        }
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    window.addEventListener("DOMContentLoaded", loadChatHistory);

    function clearChat() {
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      localStorage.removeItem("chatHistory");

      // Mostrar nuevamente el mensaje inicial del bot
      const documentosSubidos = localStorage.getItem("documentosSubidos") === "true";
      const mensaje = documentosSubidos
        ? "¬°Estoy listo para ayudarte con los documentos que subiste!"
        : "Hola! Sube tu PDF y te ayudar√© a encontrar lo que buscas.";

      appendMessage("Bot", mensaje);
    }

    // --- LOGIN ---
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const errorElem = document.getElementById('loginError');
      errorElem.style.display = 'none';

      try {
        const res = await fetch('http://localhost:5000/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (!res.ok) {
          errorElem.textContent = 'Credenciales incorrectas';
          errorElem.style.display = 'block';
          return;
        }

        const data = await res.json();
        alert(data.message);


        // Cerrar modal y limpiar inputs
        document.getElementById('loginModal').style.display = 'none';
        e.target.reset();
        // Despu√©s del login exitoso
        if (data.success) {
          localStorage.setItem("usuario", username);
          actualizarInterfazSegunLogin(); // üî• actualiza la UI inmediatamente
          ajustarNavbarSegunLogin()

          // Cerrar modal, limpiar campos
          document.getElementById('loginModal').style.display = 'none';
          e.target.reset();
        }


      } catch (err) {
        errorElem.textContent = 'Error de conexi√≥n';
        errorElem.style.display = 'block';
      }
    });


    function actualizarInterfazSegunLogin() {
      const usuario = localStorage.getItem("usuario");

      const logueado = !!usuario;
      document.getElementById("openLogin").style.display = logueado ? "none" : "inline";
      document.getElementById("openRegister").style.display = logueado ? "none" : "inline";
      document.getElementById("logoutBtn").style.display = logueado ? "inline" : "none";

      const saludo = document.getElementById("saludoUsuario");
      if (saludo) {
        if (logueado) {
          saludo.innerText = `Bienvenido, ${usuario}`;
          saludo.style.display = "inline";
        } else {
          saludo.style.display = "none";
        }
      }
    }




    function cerrarSesion() {
      localStorage.removeItem("usuario");
      actualizarInterfazSegunLogin();
      location.reload(); // recarga la p√°gina para aplicar cambios
    }

    // --- REGISTRO ---
    document.getElementById('registroForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value.trim();
      const errorElem = document.getElementById('registroError');
      errorElem.style.display = 'none';

      try {
        const res = await fetch('http://localhost:5000/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (!res.ok) {
          errorElem.textContent = 'Nombre de usuario ya en uso';
          errorElem.style.display = 'block';
          return;
        }

        alert('Registro exitoso! Ahora puedes iniciar sesi√≥n.');

        // Cerrar modal y limpiar inputs
        document.getElementById('registroModal').style.display = 'none';
        e.target.reset();

      } catch (err) {
        errorElem.textContent = 'Error de conexi√≥n';
        errorElem.style.display = 'block';
      }
    });


    // Abrir modales
    document.getElementById('openLogin').onclick = function (e) {
      e.preventDefault();
      document.getElementById('loginModal').style.display = 'block';
    }
    document.getElementById('openRegister').onclick = function (e) {
      e.preventDefault();
      document.getElementById('registroModal').style.display = 'block';
    }

    // Cerrar modales con la X
    document.getElementById('closeLogin').onclick = function () {
      document.getElementById('loginModal').style.display = 'none';
    }
    document.getElementById('closeRegister').onclick = function () {
      document.getElementById('registroModal').style.display = 'none';
    }

    // Cerrar modal clickeando fuera del contenido
    window.onclick = function (event) {
      const loginModal = document.getElementById('loginModal');
      const registroModal = document.getElementById('registroModal');
      if (event.target == loginModal) {
        loginModal.style.display = 'none';
      }
      if (event.target == registroModal) {
        registroModal.style.display = 'none';
      }
    }



    function estaLogueado() {
      return localStorage.getItem("usuario") !== null;
    }
    function ajustarNavbarSegunLogin() {
      const navbar = document.querySelector('.navbar');
      if (!navbar) return;

      const estiloActual = window.getComputedStyle(navbar);
      const paddingActual = parseInt(estiloActual.paddingRight); // en p√≠xeles

      if (estaLogueado()) {
        navbar.style.paddingRight = (paddingActual - 30) + 'px';
      } else {
        navbar.style.paddingRight = paddingActual + 'px'; // lo deja como estaba
      }
    }
    window.onload = function () {
      const logueado = estaLogueado();
      const content = document.getElementById("protectedContent");
      const loginMessage = document.getElementById("loginRequired");

      if (logueado) {
        content.style.display = "block";
        loginMessage.style.display = "none";
      } else {
        content.style.display = "none";
        loginMessage.style.display = "block";
      }

      actualizarInterfazSegunLogin(); // aplica el estado inicial seg√∫n login
      ajustarNavbarSegunLogin()
    };
  </script>
</body>

</html>