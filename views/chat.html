<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Knowledge-Navigator</title>
  <link rel="stylesheet" href="../styles/chatstyles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

</head>

<body class="chat-interface">
  <header class="navbar">
    <div class="logo"><strong>Knowledge</strong> <span class="sub">Navigator</span></div>
    <nav>

      <a class="home-btn" href="landing.html">Home</a>
      <a class="chat-btn" href="chat.html">Chat</a>
      <a class="docs-btn" href="documents.html">Documents</a>

      <a href="#">Sign In</a>
      <a href="#" id="logoutBtn" style="display:none" onclick="cerrarSesion()">Logout</a>

      <a href="#" class="btn-primary" onclick="abrirRegistro()">Get started</a>
    </nav>
  </header>

  <main class="chat-wrapper">
    <div class="chat-header">
      <div class="chat-header-title"><span class="chat-icon"><img src="../styles/images/logobot.webp" alt="Documento"
            class="bot-image"></span> Document Assistant</div>

      <label class="switch-label">
        <input type="checkbox" id="use_internet"> <span class="switch"></span>Buscar en Internet
      </label>
    </div>
    <div id="chatBox" class="chat-messages">
      <div class="message bot">
        <p>Hola! soy el asistente de documentos de tu empresa. Sube tu PDF y te ayudaré a encontrar lo que buscas.</p>
        <span class="timestamp"></span>
      </div>
    </div>

    <div class="chat-input">
      <button class="cleanChat" onclick="clearChat()"><i class="fas fa-trash-alt"></i></button>
      <input type="text" id="question" placeholder="Ask a question about your documents..." />

      <button class="send" onclick='askBot()'>➤</button>
    </div>
  </main>


  <script>
    async function uploadPDFs() {
      const files = document.getElementById("pdfFiles").files;
      const formData = new FormData();
      const BACKEND_URL = "http://localhost:5000"
      for (let file of files) formData.append("files", file);

      try {
        const res = await fetch("http://localhost:5000/upload", {
          method: "POST",
          body: formData
        });

        const contentType = res.headers.get("content-type");
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Error del servidor (${res.status}): ${text}`);
        }

        if (contentType && contentType.includes("application/json")) {
          const data = await res.json();
          alert(data.message);
        } else {
          const text = await res.text();
          alert("Respuesta no es JSON: " + text);
        }

      } catch (err) {
        console.error("Error al subir archivos:", err);
        alert("Error al subir archivos.");
      }
    }

    // Detectar si se pulsa Enter en el input
    document.getElementById("question").addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        event.preventDefault(); // Evita que se recargue la página (si está en un formulario)
        askBot(); // Llama a la función que envía el mensaje
      }
    });



    function typeResponse(text, container) {
      const messageElement = document.createElement("div");
      messageElement.className = "message bot";
      const msgContent = document.createElement("p");
      messageElement.appendChild(msgContent);
      container.appendChild(messageElement);

      let index = 0;
      const cleanText = text; // Guardar versión completa para almacenar

      function typeChar() {
        if (index < cleanText.length) {
          msgContent.textContent += cleanText.charAt(index);
          index++;
          setTimeout(typeChar, 5); // velocidad de escritura
        } else {
          // Aplicar formato markdown + saltos de línea
          msgContent.innerHTML = formatWithLineBreaks(parseMarkdownToHTML(cleanText));

          const timestamp = document.createElement("span");
          timestamp.className = "timestamp";
          timestamp.textContent = new Date().toLocaleTimeString();
          messageElement.appendChild(timestamp);

          // Guardar en historial
          saveChatHistory("Bot", cleanText, timestamp.textContent);

          container.scrollTop = container.scrollHeight;
        }
      }

      typeChar();
    }



    async function askBot() {
      const question = document.getElementById("question").value;
      const use_internet = document.getElementById("use_internet").checked;

      if (!question.trim()) return;

      appendMessage("Tú", question);
      document.getElementById("question").value = "";

      try {
        const res = await fetch("http://localhost:5000/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, use_internet })
        });

        const data = await res.json();

        let responseText = data.answer;




        if (data.source_type) {
          responseText += `\n\n<span class="source-label">[Fuente: ${data.source_type}]</span>`;
        }
        typeResponse(responseText, chatBox);


      } catch (error) {
        console.error("Error:", error);
        appendMessage("Bot", "Ocurrió un error al obtener la respuesta.");
      }
    }

    function parseMarkdownToHTML(text) {
      return text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
    }

    function formatWithLineBreaks(text) {
      return text.replace(/\n/g, "<br>");
    }

    // Función para agregar mensajes al chatBox
    function appendMessage(sender, message) {
      const chatBox = document.getElementById("chatBox");
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message", sender === "Tú" ? "user" : "bot");

      const msgContent = document.createElement("p");
      msgContent.textContent = message;

      if (sender === "Bot") {
        msgContent.innerHTML = formatWithLineBreaks(parseMarkdownToHTML(message));  // Convierte **texto** a <strong>
      } else {
        msgContent.textContent = message;
      }

      const timestamp = document.createElement("span");
      timestamp.classList.add("timestamp");
      timestamp.textContent = new Date().toLocaleTimeString();

      msgDiv.appendChild(msgContent);
      msgDiv.appendChild(timestamp);
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;

      // Guardar en localStorage
      saveChatHistory(sender, message, timestamp.textContent);
    }

    function saveChatHistory(sender, message, timestamp) {
      const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      history.push({ sender, message, timestamp });
      localStorage.setItem("chatHistory", JSON.stringify(history));
    }

    function loadChatHistory() {
      const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";  // Limpiar antes

      if (history.length === 0) {
        const documentosSubidos = localStorage.getItem("documentosSubidos") === "true";
        const mensaje = documentosSubidos
          ? "¡Estoy listo para ayudarte con los documentos que subiste!"
          : "Hola! Sube tu PDF y te ayudaré a encontrar lo que buscas.";
        appendMessage("Bot", mensaje);
      } else {
        for (let msg of history) {
          const msgDiv = document.createElement("div");
          msgDiv.classList.add("message", msg.sender === "Tú" ? "user" : "bot");


          const msgContent = document.createElement("p");
          if (msg.sender === "Bot") {
            msgContent.innerHTML = formatWithLineBreaks(parseMarkdownToHTML(msg.message));
          } else {
            msgContent.textContent = msg.message;
          }


          const timestamp = document.createElement("span");
          timestamp.classList.add("timestamp");
          timestamp.textContent = msg.timestamp;

          msgDiv.appendChild(msgContent);
          msgDiv.appendChild(timestamp);
          chatBox.appendChild(msgDiv);
        }
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    window.addEventListener("DOMContentLoaded", loadChatHistory);

    function clearChat() {
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      localStorage.removeItem("chatHistory");

      // Mostrar nuevamente el mensaje inicial del bot
      const documentosSubidos = localStorage.getItem("documentosSubidos") === "true";
      const mensaje = documentosSubidos
        ? "¡Estoy listo para ayudarte con los documentos que subiste!"
        : "Hola! Sube tu PDF y te ayudaré a encontrar lo que buscas.";

      appendMessage("Bot", mensaje);
    }



  </script>
</body>

</html>