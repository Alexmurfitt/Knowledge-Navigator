<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DocuChat - Chat</title>
  <link rel="stylesheet" href="../static/chatstyles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="chat-interface">
  <header class="navbar">
    <div class="logo"><strong>Knowledge</strong> <span class="sub">Navigator</span></div>
    <nav>

      <a class="home-btn" href="landing.html">Home</a>
      <a class="chat-btn" href="chat.html">Chat</a>
      <a class="docs-btn" href="documents.html">Documents</a>

      <a href="#">Sign In</a>
      <a href="#" class="btn-primary">Get Started</a>
    </nav>
  </header>

  <main class="chat-wrapper">
    <div class="chat-header">
      <div class="chat-header-title"><span class="chat-icon">ðŸ¤–</span> Document Assistant</div>
    <button class="cleanChat"onclick="clearChat()">Limpiar Chat</button>
  </div>
    <div id="chatBox" class="chat-messages">
      <div class="message bot">
        <p>Hola! soy el asistente de documentos de tu empresa. Sube tu PDF y te ayudarÃ© a encontrar lo que buscas.</p>
        <span class="timestamp">11:21:08 PM</span>
      </div>
    </div>
    
    <div class="chat-input">
      <input type="text" id="question" placeholder="Ask a question about your documents..." />
      <button onclick="askBot()">âž¤</button>
    </div>
  </main>


  <script>
    async function uploadPDFs() {
      const files = document.getElementById("pdfFiles").files;
      const formData = new FormData();
      for (let file of files) formData.append("files", file);

      try {
        const res = await fetch("http://localhost:5000/upload", {
          method: "POST",
          body: formData
        });

        const contentType = res.headers.get("content-type");
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Error del servidor (${res.status}): ${text}`);
        }

        if (contentType && contentType.includes("application/json")) {
          const data = await res.json();
          alert(data.message);
        } else {
          const text = await res.text();
          alert("Respuesta no es JSON: " + text);
        }

      } catch (err) {
        console.error("Error al subir archivos:", err);
        alert("Error al subir archivos.");
      }
    }


    async function askBot() {
      const question = document.getElementById("question").value;
      if (!question.trim()) return;

      // AÃ±adir pregunta del usuario al chat
      appendMessage("TÃº", question);

      // Limpiar input
      document.getElementById("question").value = "";

      try {
        const res = await fetch("http://localhost:5000/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question })
        });

        const data = await res.json();
        appendMessage("Bot", data.answer);
      } catch (error) {
        console.error("Error:", error);
        appendMessage("Bot", "OcurriÃ³ un error al obtener la respuesta.");
      }
    }

    // FunciÃ³n para agregar mensajes al chatBox
    function appendMessage(sender, message) {
      const chatBox = document.getElementById("chatBox");
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message", sender === "TÃº" ? "user" : "bot");

      const msgContent = document.createElement("p");
      msgContent.textContent = message;

      const timestamp = document.createElement("span");
      timestamp.classList.add("timestamp");
      timestamp.textContent = new Date().toLocaleTimeString();

      msgDiv.appendChild(msgContent);
      msgDiv.appendChild(timestamp);
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;

      // Guardar en localStorage
      saveChatHistory(sender, message, timestamp.textContent);
    }

    function saveChatHistory(sender, message, timestamp) {
      const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      history.push({ sender, message, timestamp });
      localStorage.setItem("chatHistory", JSON.stringify(history));
    }


    function loadChatHistory() {
      const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";  // Limpiar antes

      if (history.length === 0) {
        const documentosSubidos = localStorage.getItem("documentosSubidos") === "true";
        const mensaje = documentosSubidos
          ? "Â¡Estoy listo para ayudarte con los documentos que subiste!"
          : "Hola! Sube tu PDF y te ayudarÃ© a encontrar lo que buscas.";
        appendMessage("Bot", mensaje);
      } else {
        for (let msg of history) {
          const msgDiv = document.createElement("div");
          msgDiv.classList.add("message", msg.sender === "TÃº" ? "user" : "bot");

          const msgContent = document.createElement("p");
          msgContent.textContent = msg.message;

          const timestamp = document.createElement("span");
          timestamp.classList.add("timestamp");
          timestamp.textContent = msg.timestamp;

          msgDiv.appendChild(msgContent);
          msgDiv.appendChild(timestamp);
          chatBox.appendChild(msgDiv);
        }
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }


    window.addEventListener("DOMContentLoaded", loadChatHistory);

    function clearChat() {
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      localStorage.removeItem("chatHistory");

      // Mostrar nuevamente el mensaje inicial del bot
      const documentosSubidos = localStorage.getItem("documentosSubidos") === "true";
      const mensaje = documentosSubidos
        ? "Â¡Estoy listo para ayudarte con los documentos que subiste!"
        : "Hola! Sube tu PDF y te ayudarÃ© a encontrar lo que buscas.";

      appendMessage("Bot", mensaje);
    }



  </script>
</body>

</html>